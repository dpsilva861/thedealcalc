{% extends "base.html" %}
{% block title %}Search â€” File Organizer{% endblock %}
{% block content %}
<h1>Search Files</h1>

<div class="card">
    <form method="GET" action="{{ url_for('search') }}" class="search-form">
        <div class="search-bar">
            <input type="text" name="q" value="{{ query }}" placeholder="Search files... (e.g., 'all leases for 24 Hour Fitness')" class="search-input">
            <button type="submit" class="btn-primary">Search</button>
        </div>

        <details class="filters" {% if tags_filter or category_filter or entity_filter or type_filter or status_filter %}open{% endif %}>
            <summary>Advanced Filters</summary>
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Tags</label>
                    <input type="text" name="tags" value="{{ tags_filter }}" placeholder="tag1, tag2">
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select name="category">
                        <option value="">Any</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat == category_filter %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Entity</label>
                    <input type="text" name="entity" value="{{ entity_filter }}" placeholder="Company or property">
                </div>
                <div class="filter-group">
                    <label>Document Type</label>
                    <input type="text" name="type" value="{{ type_filter }}" placeholder="Lease, Invoice, etc.">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="">Any</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="archived" {% if status_filter == 'archived' %}selected{% endif %}>Archived</option>
                        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
                        <option value="final" {% if status_filter == 'final' %}selected{% endif %}>Final</option>
                        <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>Expired</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" name="date_start" value="{{ request.args.get('date_start', '') }}">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" name="date_end" value="{{ request.args.get('date_end', '') }}">
                </div>
            </div>
        </details>
    </form>
</div>

{% if results %}
<div class="card">
    <h2>{{ result_count }} Results</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Category</th>
                <th>Type</th>
                <th>Entities</th>
                <th>Tags</th>
                <th>Summary</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for f in results %}
        <tr>
            <td class="filename" title="{{ f.file_path }}">{{ f.filename }}</td>
            <td>{{ f.category }}{% if f.subcategory %} > {{ f.subcategory }}{% endif %}</td>
            <td>{{ f.document_type }}</td>
            <td>{{ f.entities|join(', ') }}</td>
            <td>
                {% for tag in f.tags[:4] %}
                <span class="tag-small">{{ tag }}</span>
                {% endfor %}
            </td>
            <td class="summary">{{ f.summary[:100] }}{% if f.summary|length > 100 %}...{% endif %}</td>
            <td><button onclick="openFile({{ f.id }})" class="btn-small">Open</button></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% elif query %}
<div class="card">
    <p>No results found for "{{ query }}"</p>
</div>
{% endif %}

{% if all_tags %}
<div class="card">
    <h2>Popular Tags</h2>
    <div class="tag-cloud">
        {% for tag, count in all_tags %}
        <a href="{{ url_for('search', tags=tag) }}" class="tag">{{ tag }} ({{ count }})</a>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
